<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <record id="view_oscar_envelope_filter" model="ir.ui.view">
            <field name="name">oscar.envelope.search.view</field>
            <field name="model">oscar.envelope</field>
            <field name="arch" type="xml">
                <search string="Enveloppe">
                    <field name="name"/>
                    <field name="reference_ids"/>
                    <field name="content_envelope_ids"/>
                    <field name="source_id"/>
                    <field name="destinataire_id"/>
                    <filter string="Mes Enveloppes" name="my_envelope" domain="[('user_id.id', '=', 'uid')]"/>
                    <separator/>
                    <filter string="Nouvelle" name="new" domain="[('state', '=', 'new')]"/>
                    <filter string="Envoyée" name="sent" domain="[('state', '=', 'sent')]"/>
                    <filter string="Reçue à l'Entrepôt" name="receive_warehouse"
                            domain="[('state', '=', 'receive_warehouse')]"/>
                    <filter string="Reçue au Magasin" name="receive_store" domain="[('state', '=', 'receive_store')]"/>
                    <filter string="Reçue au Siège" name="receive_siege" domain="[('state', '=', 'receive_siege')]"/>
                    <separator/>
                    <filter name="group_envelope_by_state" string="Statut" context="{'group_by':'state'}"/>
                </search>
            </field>
        </record>

        <record model="ir.ui.view" id="view_oscar_envelope_kanban">
            <field name="name">oscar.envelope.kanban</field>
            <field name="model">oscar.envelope</field>
            <field name="arch" type="xml">
                <kanban class="o_kanban_small_column" default_group_by="state" quick_create="false">
                    <field name="name"/>
                    <field name="content_envelope_ids"/>
                    <field name="state" readonly="1"/>
                    <field name="source_id"/>
                    <field name="user_id"/>
                    <field name="color"/>
                    <field name="message_needaction_counter"/>
                    <field name="activity_ids"/>
                    <field name="activity_state"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div t-attf-class="#{kanban_color(record.color.raw_value)} oe_kanban_global_click">
                                <div class="o_dropdown_kanban dropdown">
                                    <a class="dropdown-toggle o-no-caret btn" role="button" data-toggle="dropdown"
                                       href="#" aria-label="Dropdown menu" title="Dropdown menu">
                                        <span class="fa fa-ellipsis-v"/>
                                    </a>
                                    <div class="dropdown-menu" role="menu">
                                        <t t-if="widget.editable">
                                            <a role="menuitem" type="edit" class="dropdown-item">Modifier</a>
                                        </t>
                                        <t t-if="widget.deletable">
                                            <a role="menuitem" type="delete" class="dropdown-item">Supprimer</a>
                                        </t>
                                        <ul class="oe_kanban_colorpicker" data-field="color"/>
                                    </div>
                                </div>
                                <div class="oe_kanban_content">
                                    <div>
                                        <strong class="o_kanban_record_title">
                                            <field name="name"/>
                                        </strong>
                                    </div>
                                    <div>
                                        <field name="content_envelope_ids" widget="many2many_tags"
                                               options="{'color_field': 'color'}"/>
                                    </div>
                                    <div class="oe_clear">
                                        <field name="references"/>
                                    </div>
                                    <div class="oe_clear">
                                        <field name="source_id"/>
                                    </div>
                                    <div class="oe_clear">
                                        <field name="state"/>
                                    </div>
                                    <div class="o_kanban_record_bottom">
                                        <div class="oe_kanban_bottom_left">
                                            <t t-if="record.message_needaction_counter.raw_value">
                                                <span role="alert" class='oe_kanban_mail_new' title='Unread Messages'>
                                                    <i class='fa fa-comments' aria-label="Unread messages" role="img"/>
                                                    <t t-raw="record.message_needaction_counter.raw_value"/>
                                                </span>
                                            </t>
                                            <field name="activity_ids" widget="kanban_activity"/>
                                        </div>
                                        <div class="oe_kanban_bottom_right">
                                            <img t-att-src="kanban_image('res.users', 'image_small', record.user_id.raw_value)"
                                                 t-att-title="record.user_id.value" t-att-alt="record.user_id.value"
                                                 width="24" height="24" class="oe_kanban_avatar"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="oe_clear"/>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- actions liste de bordereaux des enveloppes -->
        <record model="ir.actions.act_window" id="action_bordereau_envelope">
            <field name="type">ir.actions.act_window</field>
            <field name="name">Bordereaux</field>
            <field name="res_model">oscar.bordereau</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[('envelope_ids', 'in', [active_id])]</field>
            <field name="context">{
                'create': False,
                'edit': False,
                }
            </field>
        </record>

        <!-- Enveloppe form view -->
        <record model="ir.ui.view" id="envelope_view_form">
            <field name="name">oscar.envelope.view.form</field>
            <field name="model">oscar.envelope</field>
            <field name="arch" type="xml">
                <form string="Enveloppe">
                    <header>
                        <button name="imprimer_envelope" string="Imprimer"
                                type="object" states="sent" class="oe_highlight"/>
                        <button name="%(change_source_wizard_action)d" string="Modifier la source"
                                type="action" class="oe_read_only" context="{'model_type': 'envelope'}"
                                groups="spc_oscar_aziza.group_admin_oscar"/>
                        <field name="state" widget="statusbar"
                               statusbar_visible="new,sent"/>
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button class="oe_stat_button" type="action"
                                    name="%(action_bordereau_envelope)d"
                                    icon="fa-exchange" attrs="{'invisible': [('bordereau_count', '=', 0)]}"
                                    help="Bordereaux">
                                <field string=" Bordereau(x)" name="bordereau_count" widget="statinfo"/>
                            </button>
                            <button name="toggle_active" type="object"
                                    class="oe_stat_button" groups="spc_oscar_aziza.group_admin_oscar"
                                    icon="fa-check-square-o">
                                <field name="active" widget="boolean_button"
                                       options="{&quot;terminology&quot;: &quot;Désactiver&quot;}"/>
                            </button>
                        </div>
                        <div class="oe_title">
                            <label for="name" class="oe_edit_only"
                                   string="N° Enveloppe"/>
                            <h1>
                                <field name="name"/>
                            </h1>
                        </div>
                        <group>
                            <group>
                                <field name="content_envelope_ids" domain="[('parent_id', '=', False)]"
                                       widget="many2many_tags"
                                       options="{'color_field': 'color', 'no_create_edit': True}"/>
                                <field name="bordereau_id"/>
                            </group>
                            <group>
                                <field name="date_creation" readonly="1"/>
                                <field name="date_reception"
                                       attrs="{'invisible': [('state', 'in', ['new','sent'])]}"/>
                                <field name="sending_date"
                                       attrs="{'invisible': [('state', 'in', ['new','receive_warehouse','receive_siege','receive_store'])]}"/>
                                <field name="print_date" attrs="{'invisible': [('print_date', '=', False)]}"/>
                                <field name="user_id"
                                       options="{'no_create': True, 'no_create_edit': True, 'no_open': True}"
                                       readonly="1"/>
                            </group>
                        </group>
                        <group>
                            <group>
                                <field name="source_id"
                                       options="{'no_create': True, 'no_create_edit': True, 'no_open': True}"/>
                                <field name="type_destinataire" invisible="1"/>
                                <field name="manual_filling" invisible="1"/>
                                <field name="destinataire_id"
                                       options="{'no_create': True, 'no_create_edit': True, 'no_open': True}"/>
                                <field name='destination_intermediaire_ids'
                                       attrs="{'invisible': [('state', '=', 'new')]}" widget="many2many_tags"/>
                            </group>
                            <group>
                                <field name="reference_ids" context="{'content_ids': content_envelope_ids}" nolabel="1">
                                    <tree editable="true">
                                        <field name="content_envelope_id"
                                               domain="[('has_reference', '=', True),'|',('parent_id', 'in', context.get('content_ids')),('id', 'in', context.get('content_ids'))]"
                                               options="{'no_create': True, 'no_create_edit': True}"/>
                                        <field name="name" password="1"/>
                                        <field name="confirm_name" required="1" password="1"/>
                                        <field name="user_id" invisible="1"/>
                                    </tree>
                                </field>
                            </group>
                        </group>
                        <group name="pieces_jointes">
                            <notebook>
                            </notebook>
                        </group>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers"
                               groups="base.group_user"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
            </field>
        </record>

        <!-- Enveloppe tree view -->
        <record model="ir.ui.view" id="oscar_envelope_view_tree">
            <field name="name">oscar.envelope.view.tree</field>
            <field name="model">oscar.envelope</field>
            <field name="arch" type="xml">
                <tree>
                    <field name="name"/>
                    <field name="date_creation"/>
                    <field name="source_id"/>
                    <field name="destinataire_id"/>
                    <field name="references"/>
                    <field name="user_id"/>
                    <field name="state" widget="colored_state" options="{'new': { 'class': 'badge-info', 'name': 'Nouvelle' },
					 													'sent': { 'class': 'badge-light', 'name': 'Envoyée' },
					  													'receive_warehouse': { 'class': 'badge-success', 'name': 'Reçue à l\'Entrepôt' },
					   													'receive_siege': { 'class': 'badge-success', 'name': 'Reçue au Siège' },
					   													'receive_store': { 'class': 'badge-success', 'name': 'Reçue au Magasin' }}"/>
                </tree>
            </field>
        </record>


        <record id="oscar_envelope_receive_action_server" model="ir.actions.server">
            <field name="name">Recevoir</field>
            <field name="type">ir.actions.server</field>
            <field name="model_id" ref="model_oscar_envelope"/>
            <field name="binding_model_id" ref="model_oscar_envelope"/>
            <field name="state">code</field>
            <field name="code">
                for rec in records:
                rec.recevoir_envelope()
            </field>
        </record>


        <!-- actions liste des enveloppes -->
        <record model="ir.actions.act_window" id="action_all_envelope">
            <field name="type">ir.actions.act_window</field>
            <field name="name">Enveloppes</field>
            <field name="res_model">oscar.envelope</field>
            <field name="view_mode">kanban,tree,form</field>
            <field name="domain">[]</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Créer une nouvelle Enveloppe.
                </p>
                <p>
                    Oscar vous aide à gérer facilement vos Enveloppes
                </p>
            </field>
        </record>

        <!-- actions liste de nouveaux enveloppes -->
        <record model="ir.actions.act_window" id="action_new_envelopes">
            <field name="type">ir.actions.act_window</field>
            <field name="name">Enveloppes</field>
            <field name="res_model">oscar.envelope</field>
            <field name="view_mode">kanban,tree,form</field>
            <field name="domain">[('state','=','new')]</field>
            <field name="context">{
                'search_default_new': 1,
                'delete': False,
                }
            </field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Créer une nouvelle Enveloppe.
                </p>
                <p>
                    Oscar vous aide à gérer facilement vos Enveloppes
                </p>
            </field>
        </record>

        <!-- actions liste de enveloppes envoyees -->
        <record model="ir.actions.act_window" id="action_sent_envelope">
            <field name="type">ir.actions.act_window</field>
            <field name="name">Enveloppes Envoyées</field>
            <field name="res_model">oscar.envelope</field>
            <field name="view_mode">kanban,tree,form</field>
            <field name="domain">[('state', '=', 'sent')]</field>
            <field name="context">{
                'create': False,
                'delete': False,
                }
            </field>
            <field name="help" type="html">
                <p class="o_view_nocontent_neutral_face">
                    Aucun bordereau trouvé.
                </p>
                <p>
                    Oscar vous aide à gérer facilement vos Enveloppes
                </p>
            </field>
        </record>

        <!-- actions liste des enveloppes recues -->
        <record model="ir.actions.act_window" id="action_receive_envelope">
            <field name="type">ir.actions.act_window</field>
            <field name="name">Enveloppes reçues</field>
            <field name="res_model">oscar.envelope</field>
            <field name="view_mode">kanban,tree,form</field>
            <field name="context">{
                'create': False,
                'delete': False,
                }
            </field>
            <field name="domain">[('state', 'in', ['receive_store','receive_warehouse','receive_siege'])]</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_neutral_face">
                    Aucune enveloppe trouvée.
                </p>
                <p>
                    Oscar vous aide à gérer facilement vos Enveloppes
                </p>
            </field>
        </record>


        <menuitem name="Enveloppes" id="menu_oscar_envelope"
                  parent="menu_oscar_transfer" sequence="10"
                  groups="spc_oscar_aziza.group_reponsable_magasin,spc_oscar_aziza.group_reponsable_zone,spc_oscar_aziza.group_DE,spc_oscar_aziza.group_DRE,spc_oscar_aziza.group_drh,spc_oscar_aziza.group_dhrbp,spc_oscar_aziza.group_dg"/>

        <menuitem name="Enveloppes" id="menu_oscar_all_envelopes"
                  parent="menu_oscar_envelope" action="action_all_envelope" groups="spc_oscar_aziza.group_admin_oscar"
                  sequence="10"/>

        <menuitem name="Nouvelles enveloppes" id="menu_new_envelopes"
                  parent="menu_oscar_envelope" action="action_new_envelopes"
                  sequence="20"/>

        <menuitem name="Enveloppes envoyées" id="menu_send_envelope"
                  sequence="30" parent="menu_oscar_envelope"
                  action="action_sent_envelope"/>

        <menuitem name="Enveloppes reçues"
                  id="menu_receive_envelope_magasin" sequence="40"
                  parent="menu_oscar_envelope" action="action_receive_envelope"/>

    </data>
</odoo>