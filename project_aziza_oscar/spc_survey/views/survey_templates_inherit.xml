<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>


        <template id="column_type_text_template" name="Text colum type in advanced matrix">
            <input type="text" t-att-name="'%s_%s_%s' % (prefix, row_label.id, col_label.id)" class="form-control"/>
        </template>

        <template id="column_type_textarea_template" name="textarea colum type in advanced matrix">
            <textarea rows="2" t-att-name="'%s_%s_%s' % (prefix, row_label.id, col_label.id)" class="form-control"></textarea>
        </template>

        <template id="column_type_number_template" name="number colum type in advanced matrix">
            <input type="number" t-att-min="col_label.min" t-att-max="col_label.max" step="1" t-att-name="'%s_%s_%s' % (prefix, row_label.id, col_label.id)" class="form-control" />
        </template>

        <template id="column_type_float_number_template" name="float_number colum type in advanced matrix">
            <input type="number" t-att-min="col_label.min" t-att-max="col_label.max" step="any" t-att-name="'%s_%s_%s' % (prefix, row_label.id, col_label.id)" class="form-control" />
        </template>

        <template id="column_type_date_template" name="date colum type in advanced matrix">
            <t t-set="minimum" t-value="" />
            <t t-set="maximum" t-value="" />
            <t t-set="today" t-value="" />
            <t t-if="col_label.today">
                <t t-set="today" t-value="col_label.today" />
            </t>
            <t t-if="today">
                <t t-if="today == 'lte_today'"><t t-set="maximum" t-value="question.date_today(col_label.today)"/></t>
                <t t-if="today == 'lt_today'"><t t-set="maximum" t-value="question.date_today(col_label.today)"/></t>
                <t t-if="today == 'gte_today'"><t t-set="minimum" t-value="question.date_today(col_label.today)"/></t>
                <t t-if="today == 'gt_today'"><t t-set="minimum" t-value="question.date_today(col_label.today)"/></t>
            </t>
            <t t-if="col_label.min_date">
                <t t-set="minimum" t-value="col_label.min_date" />
            </t>
            <t t-if="col_label.max_date">
                <t t-set="maximum" t-value="col_label.max_date" />
            </t>
            <div class="form-group">
	            <div class="input-group date" t-attf-id="datetimepicker_#{'%s_%s_%s' % (prefix, row_label.id, col_label.id)}" data-target-input="nearest" t-att-data-mindate="minimum"
                    t-att-data-maxdate="maximum">
		            <input type="text" class="form-control datetimepicker-input" t-attf-data-target="#datetimepicker_#{'%s_%s_%s' % (prefix, row_label.id, col_label.id)}" t-att-name="'%s_%s_%s' % (prefix, row_label.id, col_label.id)"/>
		            <div class="input-group-append" t-attf-data-target="#datetimepicker_#{'%s_%s_%s' % (prefix, row_label.id, col_label.id)}" data-toggle="datetimepicker">
		                <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                    </div>
	            </div>
	        </div>
        </template>

        <template id="column_type_dropdown_template" name="dropdown colum type in advanced matrix">
            <div class="js_drop row">
                <div class="col-lg-12">
                    <select class="form-control" t-att-name="'%s_%s_%s' % (prefix, row_label.id, col_label.id)">
                        <option disabled="1" selected="1" value="">Choose...</option>
                        <t t-set="choices" t-value="col_label.options.split(',')"/>
                        <t t-foreach='choices' t-as='choice'>
                            <option><t t-esc='choice'/></option>
                        </t>
                    </select>
                </div>
            </div>
        </template>

        <template id="column_type_attachment_template" name="attachment colum type in advanced matrix">
			    <div>
				    <input type="file" class="file form-control" multiple="multiple" t-att-name="'%s_%s_%s' % (prefix, row_label.id, col_label.id)" />
                    <ul t-att-name="'%s_%s_%s' % (prefix, row_label.id, col_label.id)">

                    </ul>
				</div>
        </template>

        <!-- cam modal template -->
	    <template id="cam_modal_template" name="Cam model template">
            <div id="snapModal" class="modal snapModal">
				<div>
					<video autoplay="autoplay"></video>
				</div>
				<div class="controls">
					<button class="screenshot btn btn-outline-success" title="Capture">
						<i class="fa fa-camera fa-3x" />
					</button>
				</div>
				<div>
					<a class="cancel-snapshot btn btn-danger float-left ml-2" href="#" rel="modal:close">
						<i class="fa fa-times-circle fa-2x"> Cancel</i>
					</a>
					<a class="valid-snapshot d-none btn btn-success float-left ml-2" href="#" rel="modal:close">
					    <i class="fa fa-check-circle fa-2x"> Validate</i>
					</a>
					<a class="retry-snapshot d-none btn btn-primary float-left ml-2" href="#">
						<i class="fa fa-reply-all fa-2x"> Try Again</i>
					</a>
				</div>
			</div>
	    </template>

        <template id="column_type_cam_template" name="cam colum type in advanced matrix">
            <div t-att-name="'%s_%s_%s' % (prefix, row_label.id, col_label.id)" class="picture-div" style="display:flex">
                <a role="button" class="btn btn-primary play mr-2 align-self-start" href="#snapModal" rel="modal:open">
                    <i class="fa fa-camera fa-2x"></i>
                </a>
                <input type="hidden" t-att-name="'%s_%s_%s' % (prefix, row_label.id, col_label.id)" value="" />
			</div>
        </template>

        <!--advanced_matrix_template-->
        <template id="advanced_matrix_template" name="Advanced Matrix">

            <table class="table table-hover input-fit-width table-responsive">
                <thead>
                    <tr>
                        <th></th>
                        <th t-foreach="question.labels_adv_matrix_cols_ids" t-as="col_label">
                            <span t-field="col_label.value"/>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr t-foreach="question.labels_adv_matrix_rows_ids" t-as="row_label">
                        <th>
                            <span t-field="row_label.value"/>
                        </th>
                        <td t-foreach="question.labels_adv_matrix_cols_ids" t-as="col_label">
                            <!-- call column type template -->
                            <t t-if="col_label.col_type_resp == 'text'"><t t-call="spc_survey.column_type_text_template"/></t>
                            <t t-if="col_label.col_type_resp == 'textarea'"><t t-call="spc_survey.column_type_textarea_template"/></t>
                            <t t-if="col_label.col_type_resp == 'number'"><t t-call="spc_survey.column_type_number_template"></t></t>
                            <t t-if="col_label.col_type_resp == 'float_number'"><t t-call="spc_survey.column_type_float_number_template"/></t>
                            <t t-if="col_label.col_type_resp == 'date'"><t t-call="spc_survey.column_type_date_template"/></t>
                            <t t-if="col_label.col_type_resp == 'dropdown'"><t t-call="spc_survey.column_type_dropdown_template"/></t>
                            <t t-if="col_label.col_type_resp == 'attachment'"><t t-call="spc_survey.column_type_attachment_template"/></t>
                            <t t-if="col_label.col_type_resp == 'cam'"><t t-call="spc_survey.column_type_cam_template"/></t>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div t-if='question.comments_allowed'>
                <span t-field="question.comments_message"/>
                <input type="text" class="form-control" t-att-name="'%s_%s' % (prefix, 'comment')"/>
            </div>
        </template>

        <!-- page inherit -->
        <template id="survey_page_inherit" inherit_id="survey.page">

            <!-- call advanced_matrix_template -->
            <xpath expr="//div[@class='js_question-wrapper']/t[7]" position="after">
                <t t-if="question.type == 'advanced_matrix'">
                    <t>
                        <t t-call="spc_survey.advanced_matrix_template"/>
                    </t>
                </t>
            </xpath>

            <!-- cam modal template-->
            <xpath expr="//div" postion="after">
                <t t-call="spc_survey.cam_modal_template"/>
            </xpath>

            <!-- add survey_session_info value to get it in submit controller via post['survey_session_info_hidden'] -->
            <xpath expr="//input[@name='token']" position="after">
                <input t-if="survey_session_info" type="hidden" name="survey_session_info_hidden" t-att-value="slug(survey_session_info)" />
            </xpath>

            <xpath expr='//button[@t-if="last"]' position="attributes">
                <attribute name="class">btn btn-primary loading_class</attribute>
            </xpath>

            <xpath expr='//button[@t-if="not last"]' position="attributes">
                <attribute name="class">btn btn-primary loading_class</attribute>
            </xpath>



        </template>

        <!--call advanced_matrix_template : print case-->
        <template id="survey_print_inherit" inherit_id="survey.survey_print">

            <!-- cam modal template to use it in edit mode : in edit mode we have no access to page template
            this is why I'm adding this here ;) -->
            <xpath expr="//div[@class='jumbotron mt32']" postion="before">
                <t t-call="spc_survey.cam_modal_template"/>
            </xpath>

            <xpath expr="//t[@t-call='survey.back']" position="after">
                <t t-if="'view_answers' not in request.httprequest.full_path">
                    <t t-call="spc_survey.edit" />
                </t>

            </xpath>

            <xpath expr="//div[@role='form']" position="replace">

                <form method="post" class="js_surveyform" t-att-name="'%s' % (survey.id)" t-att-data-prefill="'/survey/prefill/%s/%s' % (slug(survey), token)"
                      t-att-action="'/survey/save/%s/%s' % (slug(survey), token)" t-att-data-save="'/survey/save/%s/%s' % (slug(survey), token)" >
                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                        <t t-foreach="survey.page_ids" t-as="page">
                            <div class="o_page_header">
                                <h1 t-field='page.title' />
                                <t t-if="page.description"><div t-field='page.description' class="oe_no_empty"/></t>
                            </div>
                            <t t-foreach='page.question_ids' t-as='question'>
                                <t t-set="prefix" t-value="'%s_%s_%s' % (survey.id, page.id, question.id)" />
                                <div class="js_question-wrapper" t-att-id="prefix">
                                    <h2>
                                        <span t-field='question.question' />
                                        <span t-if="question.constr_mandatory" class="text-danger">*</span>
                                        <span t-if="quizz_correction" class="badge badge-pill" t-att-data-score-question="question.id"></span>
                                    </h2>
                                    <t t-if="question.description"><div class="text-muted oe_no_empty" t-field='question.description'/></t>
                                    <t t-if="question.type == 'free_text'"><t t-call="survey.free_text"/></t>
                                    <t t-if="question.type == 'textbox'"><t t-call="survey.textbox"/></t>
                                    <t t-if="question.type == 'numerical_box'"><t t-call="survey.numerical_box"/></t>
                                    <t t-if="question.type == 'date'"><t t-call="survey.date"/></t>
                                    <t t-if="question.type == 'simple_choice'"><t t-call="survey.simple_choice"/></t>
                                    <t t-if="question.type == 'multiple_choice'"><t t-call="survey.multiple_choice"/></t>
                                    <t t-if="question.type == 'matrix'"><t t-call="survey.matrix"/></t>
                                    <t t-if="question.type == 'advanced_matrix'">
                                        <t>
                                            <t t-call="spc_survey.advanced_matrix_template"/>
                                        </t>
                                    </t>
                                    <div class="js_errzone alert alert-danger" style="display:none;" role="alert"></div>
                                </div>
                            </t>
                            <hr/>
                        </t>
                        <div class="text-center mt16 mb16">
                            <button t-if="edit" type="submit" class="btn btn-primary btn-lg loading_class" name="button_submit" value="finish">Save</button>
                        </div>
                    </form>

            </xpath>

        </template>

        <!-- edit survey responses template -->
        <template id="edit" name="Edit Survey Responses">
            <t t-set="edit_url" t-value="'/survey/edit/%s/%s' % (slug(survey), token)" />
            <div class="float-left">
                <t t-if="not edit"> <!-- /survey/print case : edit not passed in vals -->
                    <a role="button" t-att-href="edit_url" class="btn btn-secondary btn-lg loading_class">
                    Edit
                    </a>
                    <input type="hidden" name="case" value="print" />
                </t>
                <t t-if="edit"> <!-- /survey/edit case : edit passed in vals inside edit controller-->
                    <input type="hidden" name="case" value="edit" />
                </t>
            </div>
        </template>

        <template id="sfinished_inherit" inherit_id="survey.sfinished">
            <xpath expr="//t[@t-call='survey.layout']" position="replace">
                <t t-call="survey.layout">
                    <div class="wrap">
                        <div class="container">
                            <t t-call="survey.back" />
                            <div class="jumbotron mt32">
                                <h1>Thank you!</h1>
                                <div t-field="survey.thank_you_message" class="oe_no_empty" />
                                <!-- In advanced matrix : no quizz mode-->
                                <t t-set="is_adv_matrix" t-value="env['survey.question'].search([('survey_id','=',survey.id),('type','=','advanced_matrix')],limit=1).id" />
                                <t t-if="not is_adv_matrix">
                                    <div t-if='survey.quizz_mode'>You scored <t t-esc="user_input.quizz_score" /> points.</div>
                                </t>
                                <div>If you wish, you can <a t-att-href="'/survey/print/%s/%s' % (slug(survey), token)" target="_blank" class="font-weight-bold">review and edit your answers</a>.</div>

                                <div t-if="survey_session_info">
	                        	    <t t-set="survey_session_surveys" t-value="survey_session_info.survey_session_id.survey_ids" />
	                        	    <t t-set="next_surv" />
	                        	    <t t-foreach="survey_session_surveys" t-as="surv">
	                        		    <t t-if="surv == survey">
	                        			    <t t-if="surv_index != len(survey_session_surveys)-1">
                                                <!-- not the last in session -->
	                        				    <t t-set="next_surv" t-value="survey_session_surveys[surv_index+1]"/>
	                        			    </t>
	                        			    <t t-else="">
                                                <!-- last in session -->
	                        				    <t t-set="next_surv" t-value="len(survey_session_surveys)-1" />
	                        				    <h3 class="jumbotron alert alert-info">CORRECTION TIME</h3>
	                        				    <div>
	                        					    <a t-if="next_surv == len(survey_session_surveys)-1" class="btn btn-warning loading_class" role="button">Correction Table</a>
	                        				    </div>
	                        			    </t>
	                        		    </t>
	                        	    </t>
	                        	    <a t-if="next_surv != len(survey_session_surveys)-1" t-att-href="'/survey/start/%s/%s' % (slug(next_surv),slug(survey_session_info))" class="btn btn-info btn-lg loading_class" role="button">Next page</a>
	                            </div>
                                <div t-if="not survey_session_info">
                                    <t t-if="not env['survey.user_input'].search([('token','=',token)]).survey_session_info_id">
                                        <h3 class="jumbotron alert alert-info">Scoring</h3>
                                        <div>
                                            <a class="btn btn-warning loading_class" role="button" t-att-href="'/survey/scoring/%s/%s' % (slug(survey), token)">Click!</a>
                                        </div>
                                    </t>
                                </div>

                            </div>
                        </div>
                    </div>
                </t>
            </xpath>
        </template>


        <!-- start button -->
	    <template id="survey_init_inherit" inherit_id="survey.survey_init">

            <xpath expr="//a[@role='button']" position="replace">
                <t t-if="survey_session_info">
                    <a role="button" class="btn btn-primary btn-lg loading_class" t-att-href="'/survey/fill/%s/%s/%s' % (slug(survey), token, slug(survey_session_info))">
                    Start
                    </a>
                </t>
                <t t-else="">
                    <a role="button" class="btn btn-primary btn-lg loading_class" t-att-href="'/survey/fill/%s/%s' % (slug(survey), token)">
                    Start
                    </a>
                </t>
            </xpath>

        </template>


        <template id="single_survey_scores" name="Single survey scores">
            <t t-call="survey.layout">
                <div class="wrap">
                    <div class="container">
                        <t t-set="response" t-value="env['survey.user_input'].search([('token','=',token)])" />
                        <br/>
                        <div>
                            <table class="table table-bordered text-center border border-dark">
                                <thead>
                                    <tr>
                                        <th>Survey</th>
                                        <th>Score</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="align-middle"> <t t-esc="response.survey_id.title" /> </td>
                                        <td class="align-middle"> <t t-if="len(response.criteria_ids) != 0"> <t t-esc="round(response.final_score)" /> %</t></td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="2">
                                            <a role="button" class="btn btn-primary btn-lg loading_class" t-att-href="'/survey/end_session/%s' % (token)">
                                                Back
                                            </a>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </t>
        </template>







    </data>
</odoo>
